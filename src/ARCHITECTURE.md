# 擴充套件架構圖

## 整體架構

```
┌─────────────────────────────────────────────────────────────┐
│                    Chrome Extension                          │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Presentation Layer                         │ │
│  │                                                          │ │
│  │  ┌────────────────────────────────────────────────┐   │ │
│  │  │      ShareButtonController (UI)                 │   │ │
│  │  │                                                  │   │ │
│  │  │  • 注入按鈕到頁面                               │   │ │
│  │  │  • 處理點擊事件                                 │   │ │
│  │  │  • 管理載入狀態                                 │   │ │
│  │  │  • 顯示通知                                     │   │ │
│  │  │  • 複製到剪貼簿                                 │   │ │
│  │  └────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────┘ │
│                            │                                  │
│                            ↓                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Application Layer                          │ │
│  │                                                          │ │
│  │  ┌────────────────────────────────────────────────┐   │ │
│  │  │      SharePobUseCase (業務邏輯)                │   │ │
│  │  │                                                  │   │ │
│  │  │  • 驗證 PoB 代碼                                │   │ │
│  │  │  • 協調擷取與上傳                               │   │ │
│  │  │  • 建立分享連結                                 │   │ │
│  │  │  • 統一錯誤處理                                 │   │ │
│  │  └────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────┘ │
│                            │                                  │
│                            ↓                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Domain Layer                               │ │
│  │                                                          │ │
│  │  ┌──────────────────┐    ┌─────────────────────┐      │ │
│  │  │ PobShareResult   │    │    ApiError         │      │ │
│  │  │                  │    │                     │      │ │
│  │  │ • hash           │    │ • message           │      │ │
│  │  │ • url            │    │ • code              │      │ │
│  │  │ • isReused       │    │                     │      │ │
│  │  └──────────────────┘    └─────────────────────┘      │ │
│  └────────────────────────────────────────────────────────┘ │
│                            ↑                                  │
│                            │                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │           Infrastructure Layer                          │ │
│  │                                                          │ │
│  │  ┌────────────────────┐    ┌─────────────────────┐    │ │
│  │  │ ChroniclesApiClient│    │PoeNinjaPobExtractor │    │ │
│  │  │                    │    │                     │    │ │
│  │  │ • uploadPobCode()  │    │ • extractFromPage() │    │ │
│  │  └────────────────────┘    └─────────────────────┘    │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
         │                                    │
         ↓                                    ↓
┌──────────────────┐              ┌────────────────────┐
│  poe2db.tw API   │              │   poe.ninja DOM    │
│                  │              │                    │
│ POST /api/paste  │              │ <a href="pobb.in"> │
└──────────────────┘              └────────────────────┘
```

## 資料流程

```
使用者
  │
  │ 1. 點擊「分享中文 PoB」按鈕
  ↓
ShareButtonController
  │
  │ 2. 呼叫擷取器
  ↓
PoeNinjaPobExtractor ────→ poe.ninja 頁面 DOM
  │                         (擷取 PoB 代碼)
  │ 3. 回傳 PoB 代碼
  ↓
SharePobUseCase
  │
  │ 4. 驗證並呼叫 API 客戶端
  ↓
ChroniclesApiClient
  │
  │ 5. POST https://poe2db.tw/pob/api/paste
  │    { "content": "<PoB_CODE>" }
  ↓
poe2db.tw API
  │
  │ 6. 回傳 { "code": 200, "hash": "xxx" }
  ↓
ChroniclesApiClient
  │
  │ 7. 回傳給 UseCase
  ↓
SharePobUseCase
  │
  │ 8. 建立 PobShareResult
  ↓
ShareButtonController
  │
  │ 9. 複製連結到剪貼簿
  │ 10. 顯示成功通知
  ↓
使用者看到通知並可貼上連結
```

## 依賴關係

```
┌─────────────────────────────────────┐
│ ShareButtonController               │
│ (Presentation)                      │
└─────────────────────────────────────┘
              │ 依賴
              ↓
┌─────────────────────────────────────┐
│ SharePobUseCase                     │
│ (Application)                       │
└─────────────────────────────────────┘
              │ 依賴
              ↓
┌─────────────────────────────────────┐
│ PobShareResult, ApiError            │
│ (Domain - 核心，無依賴)             │
└─────────────────────────────────────┘
              ↑ 被依賴
              │
┌─────────────┴───────────────────────┐
│ ChroniclesApiClient                  │
│ PoeNinjaPobExtractor                 │
│ (Infrastructure)                     │
└─────────────────────────────────────┘
```

## UI 狀態機

```
           初始化
              │
              ↓
      ┌──────────────┐
      │    Idle      │ ← ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
      │  按鈕可點擊   │                      │
      └──────────────┘                      │
              │                             │
    使用者點擊按鈕                           │
              │                             │
              ↓                             │
      ┌──────────────┐                      │
      │   Loading    │                      │
      │ 顯示載入動畫  │                      │
      │  按鈕禁用     │                      │
      └──────────────┘                      │
              │                             │
         API 完成                           │
              │                             │
       ┌──────┴──────┐                     │
       │             │                     │
   成功 ↓             ↓ 失敗               │
┌─────────────┐  ┌─────────────┐          │
│   Success   │  │    Error    │          │
│ 顯示成功通知 │  │ 顯示錯誤通知 │          │
│ 複製連結     │  │             │          │
└─────────────┘  └─────────────┘          │
       │             │                     │
       │             │                     │
       └──────┬──────┘                     │
              │ 3 秒後                     │
              └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
```

## 錯誤處理流程

```
任何步驟發生錯誤
       │
       ↓
  捕獲錯誤
       │
       ├─→ ApiError → 顯示特定錯誤訊息
       │
       ├─→ Network Error → 「網路連線失敗」
       │
       ├─→ Invalid Input → 「PoB 代碼無效」
       │
       └─→ Unknown Error → 「分享失敗」
       │
       ↓
顯示錯誤通知
       │
       ↓
Console 記錄詳細錯誤
       │
       ↓
按鈕回到 Idle 狀態
```

## 目錄結構

```
PoE/
├── rest-api.http              # API 測試檔案
├── test-pob-code.txt          # 測試用 PoB 代碼
└── src/                       # ← Chrome 擴充套件
    ├── manifest.json          # 擴充套件設定
    ├── content.js             # 主要邏輯（Clean Architecture）
    ├── styles.css             # UI 樣式
    ├── generate-icons.sh      # 圖示生成腳本
    ├── README.md              # 專案說明
    ├── INSTALL.md             # 安裝指南
    ├── SUMMARY.md             # 專案總覽
    ├── ARCHITECTURE.md        # 本檔案
    └── icons/                 # 圖示資源
        ├── icon.svg           # SVG 原始檔
        ├── icon16.png         # 16x16
        ├── icon48.png         # 48x48
        └── icon128.png        # 128x128
```

## Clean Architecture 優勢

✅ **可測試性**
- 每層可獨立測試
- 不依賴外部服務

✅ **可維護性**
- 職責分離清晰
- 修改影響範圍小

✅ **可擴展性**
- 新增功能不影響現有程式碼
- 可輕鬆替換實作

✅ **可讀性**
- 程式碼結構清晰
- 易於理解與協作

